{"ts":1360476333320,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"\nvar app = require('http').createServer(handler);\nvar fs = require('fs');\nvar io = require('socket.io').listen(app);\nvar port = process.env.PORT || 5000;\napp.listen(port);\n\n// websockets not supported yet\nio.configure(function () { \n io.set(\"transports\", [\"xhr-polling\"]); \n  io.set(\"polling duration\", 10); \n});\n\nfunction handler (req, res) {\n  fs.readFile(__dirname + '/index.html',\n  function (err, data) {\n    if (err) {\n      res.writeHead(500);\n      return res.end('Error loading index.html');\n    }\n\n    res.writeHead(200);\n    res.end(data);\n  });\n}\n\nfunction cell(_x,_y){ \n  this.x=_x;\n  this.y=_y;\n\n  this.energy =0;\n  this.threshold = 100;\n  this.gotGrass = false;\n  this.spreadTo =false;\n\n\n  this.gotRabbit=false;\n  this.rabbitEnergy=100;\n  this.rabbitThreshold =200;\n  this.reporduce=false;\n  this.hop=false\n\n    \n  this.update = update;\n  function update(){\n     if(this.gotRabbit){\n        if(this.rabbitEnergy>this.rabbitThreshold){\n           this.rabbitEnergy /=2;\n           reproduce=true;\n        }\n        else{\n           this.rabbitEnergy--;\n           if(this.energy<=25) {\n              if(( Math.floor(Math.random()*10 ) % 10) ==1){\n                 this.rabbitEnergy -= 5;\n                  hop=true;\n              }\n           }\n           if(this.energy >0)\n           {\n             this.rabbitEnergy+=5;\n             this.energy -=2;\n           }\n        }\n       if(this.rabbitEnergy<=0) this.gotRabbit=false;\n      }\n    \n     if(this.gotGrass){\n        if (this.energy > this.threshold) {\n\t   //choose random cell\n           //add to cell\n           this.energy /=2;\n           this.spreadTo=true;\n         \n       }       \n       else{\n          this.energy++;\n        }\n        if(this.energy<=0) {this.energy=0; this.gotGrass=false;}\n     }\n  }\n}\n\nvar Forest = function(){\n   this.maxTrees = 1000;\n   this.growthRate = 1;\n   this.trees =0;\n   this.updateForest = updateForest;\n   this.setLevel =setLevel;\n   this.level =1;\n   this.wood =0;\n   this.deathRate=0.001;\n   this.maxWood=500;\n   \n   function setLevel(level){\n       this.level =level;\n       this.growthRate *=level;\n       this.maxTrees *= level;\n       \n       this.maxWood *=level;\n   }\n\n   function updateForest(dt){\n      this.trees +=  (this.growthRate *dt);\n\n      if(this.trees > this.maxTrees) this.trees = this.maxTrees;\n\n      this.wood += this.trees * (this.deathRate* dt);\n      this.trees -= this.deathRate*dt;\n\n      if(this.wood > this.maxWood) this.wood = this.maxWood;\n      if(this.trees<0) this.trees=0;\n   }  \n}\n\nvar Field = function(){\n   this.cells = {};\n   this.numCells = 10;\n};\n\n\nField.prototype.speadTo = function(x,y){  \n  newX=((Math.floor(Math.random() * 3))-1)\n  newY=((Math.floor(Math.random() * 3))-1)\n  console.log(\"multiply \" + i + \" , \" + j  );\n  \n   if(x+newX >= numCells) return;\n   if(x+newX <= 0) return;\n   \n   if(y+newY >= numCells) return;\n   if(y+newY <= 0) return;\n                               \n   this.cells[x+newX][y+newY].gotGrass=true;\n   this.cells[x+newX][y+newY].energy=35;\n}\n/*\nfunction hop(x,y){\n   var newX=(Math.floor(Math.random() * 4))-2;\n   var newY=(Math.floor(Math.random() * 4))-2;\n//console.log(newX +\" \"  + newY + \" \"+x + \" \"+y);\n   if(x+newX >= numCells) return;\n   if(x+newX <= 0) return;\n   \n   if(y+newY >= numCells) return;\n   if(y+newY <=0) return;\n\n   this.cells[x][y].gotRabbit = false;\n   this.cells[x+newX][y+newY].gotRabbit=true;\n}\n\nfunction reproduce(x,y){\n  newX=((Math.floor(Math.random() * 3))-1)\n  newY=((Math.floor(Math.random() * 3))-1)\n\n  if(x+newX >=numCells) return;\n  if(x+newX <= 0) return;\n   \n   if(y+newY >= numCells) return;\n   if(y+newY <=0) return;\n\n   this.cells[x+newX][y+newY].gotRabbit=true;\n   this.cells[x+newX][y+newY].rabbitEnergy=50;\n}\n\n*/\n\nField.prototype.init = function(_cells){   \nthis.cells=_cells;\nthis.cells[2][2].gotGrass =  true;\nthis.cells[2][2].energy = 100;\nthis.cells[2][9].gotGrass  = true;\nthis.cells[2][9].energy = 100;\nthis.cells[5][5].gotGrass  = true;\nthis.cells[5][5].energy = 100;\nthis.cells[6][5].gotGrass  = true;\nthis.cells[6][5].energy = 100;\nthis.cells[5][4].gotGrass  = true;\nthis.cells[5][4].energy = 100;\nthis.cells[4][4].gotGrass  = true;\nthis.cells[4][4].energy = 100;\n\nthis.cells[9][2].gotGrass  = true;\nthis.cells[9][2].energy = 100;\nthis.cells[9][9].gotGrass  = true;\nthis.cells[9][9].energy = 100;\n\nthis.cells[5][5].gotRabbit = true;\nthis.cells[2][2].gotRabbit = true;\nthis.cells[9][9].gotRabbit = true;\nthis.cells[5][5].gotRabbit = true;\n}\n\n\n\nField.prototype.update = function(){    \n   for (i=0;i<this.numCells;i++){\n      for(j=0;j<this.numCells;j++){\n         this.cells[i][j].update();\n         if(this.cells[i][j].spreadtTo){ \n            console.log(\"tye spread\");\n            this.spreadTo(i,j);\n            this.cells[i][j].spreadTo=false;\n         }\n      }\n   }\n};\n\nthis.cells={};\nnumCells=10;\n\nfor (i=0;i<numCells;i++){\n       cellsRow = {};\n       for (j=0;j<numCells;j++){\n         cellsRow[j] = new cell(i,j);\n       }\n   this.cells[i]= cellsRow;\n}\n\nvar fields =  new Field();\nfields.init(this.cells);\nsetInterval(function(){ fields.update(); }, 100 );\t\n\nvar dt=new Date().getTime();\nvar lastUpdate = dt;\nvar count=0\nsetInterval(sendTime, 1000);\nfunction sendTime(){\n   io.sockets.emit('updateTime', new Date());\n   dt = new Date().getTime()-lastUpdate;\n   lastUpdate = new Date().getTime();\n  \n   \n   io.sockets.emit('refresh',1);\n   io.sockets.emit('cells',fields.cells);\n   \n}\n\n// usernames which are currently connected to the chat\nvar usernames = {};\n\nio.sockets.on('connection', function (socket) {\n\n\n   // when the client emits 'adduser', this listens and executes\nsocket.on('adduser', function(username){\n   // we store the username in the socket session for this client\n\n   socket.username = username;\n\n   // add the client's username to the global list\n   usernames[username] = username;\n\n  // echo to client they've connected\n   socket.emit('updatechat', 'SERVER', 'you have connected');\n\n   // echo globally (all clients) that a person has connected\n   socket.broadcast.emit('updatechat', 'SERVER', username + ' has connected');\n   \n // update the list of users in chat, client-side\n   io.sockets.emit('updateusers', usernames);\n\n});\n\n\n\n// when the user disconnects.. perform this\n\nsocket.on('disconnect', function(){\n\n   // remove the username from global usernames list\n  delete usernames[socket.username];\n\n   // update list of users in chat, client-side\n   io.sockets.emit('updateusers', usernames);\n\n   // echo globally that this client has left\n   socket.broadcast.emit('updatechat', 'SERVER', socket.username + ' has disconnected');\n\n});\n\n});\n\n"]],"start1":0,"start2":0,"length1":0,"length2":6616}]],"length":6616}
